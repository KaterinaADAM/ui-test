package org.exoplatform.selenium.platform.wiki.functional.pagepermission;

import static org.exoplatform.selenium.TestLogger.info;

import org.exoplatform.selenium.Dialog;
import org.exoplatform.selenium.platform.ManageAccount;
import org.exoplatform.selenium.platform.wiki.Permalink;
import org.openqa.selenium.By;
import org.testng.annotations.*;


/**
 * @author phuongdt
 *
 */
public class Wiki_PagePermission_Delete extends Permalink{

	ManageAccount magAc;
	Dialog dialog;

	@BeforeMethod
	public void beforeTest(){
		initSeleniumTest();
		driver.get(baseUrl);
		magAc = new ManageAccount(driver);
		magAc.signIn(DATA_USER1, DATA_PASS);
		dialog = new Dialog(driver);
		goToWiki();
	}

	@AfterMethod
	public void afterTest(){
		//signOut();
		driver.manage().deleteAllCookies();
		driver.quit();
	}

	/**
	 *Case ID:78330.
	 *Test Case Name: Delete permissions for a user.
	 *Pre-Condition: - wiki page PageA is already created
	- User A has permissions on PageA: View Pages or Edit Pages or both in Page Permissions
	- User A does not belong to any groups who have permission to View Pages, Edit Pages, in Wiki Settings
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test01_DeletePermissionsForAUser() {
		info("Test 1: Delete permissions for a user");
		String title = "title78330";
		String content = "content78330";
		String new_content = "newcontent78330";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String[] userGroup = {user};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(1, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		checkAndEditPagePermission(user, 2);

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);

		/*Step Number: 1
		 *Step Name: Step 1: Open Page Permissions of PageA
		 *Step Description: 
			- Open the wiki page PageA
			- Select More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			- Page Permissions form displays*/

		/*Step number: 2
		 *Step Name: Step 2: Delete permission for User A
		 *Step Description: 
			- Check the User A permissions
			- Click Delete icon corresponding to User A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			User A is removed from Page Permissions*/	
		deletePermissionWithUserAdmin(user, element_page);

		/*Step number: 3
		 *Step Name: Step 3: Check if User A have permission
		 *Step Description: 
			- Login as User A
			- Go to the space 
			-
			-> Wiki
		 *Input Data: 

		 *Expected Outcome: 
			User A will not see the wiki page PageA anymore*/
		checkViewPage(ManageAccount.userType.AUTHOR, element_page);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);
	}

	/**
	 *Case ID:113645.
	 *Test Case Name: Delete Edit permission for a user.
	 *Pre-Condition: - wiki page PageA already is created
	- User A has permissions on PageA: View Pages, Edit Pages in Page Permissions
	- User A does not belong to any group who has Edit Pages in Page Permissions
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test02_DeleteEditPermissionForAUser() {
		info("Test 2: Delete Edit permission for a user");
		String title = "title113645";
		String content = "content113645";
		String new_content = "newcontent113645";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String[] userGroup = {user};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(1, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		editPagePermission(user, true, true);

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);

		/*Step Number: 1
		 *Step Name: Step 1: Open Page Permissions form
		 *Step Description: 
			- Open the wiki page PageA
			- Go to More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			Page Permissions form displays*/

		/*Step number: 2
		 *Step Name: Step 2: Delete Edit Pages permission for User A
		 *Step Description: 
			- Check the User A permission
			- In the permission table, untick the Edit Pages checkbox of the User A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			- Edit Pages checkbox is deselected*/
		goToWikiPage("Wiki Home/" + title, ManageAccount.userType.ADMIN);
		editPagePermission(user, true, false);
		magAc.signOut();

		/*Step number: 3
		 *Step Name: Step 3: Check if the User A has Edit Pages permission
		 *Step Description: 
			- Login as User A
			- Go to space 
			-
			-> Wiki
			- Select PageA
		 *Input Data: 

		 *Expected Outcome: 
			- The user A can view the wiki page PageA but cannot see Edit Page, Add Page; Move Page and Delete Page from More menu*/ 
		magAc.signIn(user, DATA_PASS);
		goToWiki();
		click(By.linkText(title));
		waitForElementNotPresent(ELEMENT_EDIT_PAGE_LINK);
		waitForElementNotPresent(ELEMENT_ADD_PAGE_LINK);
		click(ELEMENT_MORE_LINK);
		waitForElementNotPresent(ELEMENT_DELETE_LINK);
		waitForElementNotPresent(ELEMENT_MOVE_PAGE_LINK);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);
	}

	/**
	 *Case ID:113646.
	 *Test Case Name: Delete Edit permission for a group.
	 *Pre-Condition: - wiki page PageA already is created
	- Group A already has permissions on the wiki page PageA: View Pages, Edit Pages in Page Permissions
	- Member of Group A does not belong to any groups who have Edit Pages permission in Page Permissions
	- Member of Group A does not have Edit Pages permission in Page Permissions
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test03_DeleteEditPermissionForAGroup() {
		info("Test 3: Delete Edit permission for a group");
		String title = "title113647";
		String content = "content113647";
		String new_content = "newcontent113647";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String path = "*:/organization/employees";
		String[] userGroup = {path};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(0, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		editPagePermission(path, true, true);

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);
		/*Step Number: 1
		 *Step Name: Step 1: Open the wiki page
		 *Step Description: 
			- Open the wiki page PageA
			- Go to More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			Page Permissions form displays*/

		/*Step number: 2
		 *Step Name: Step 2: Delete Edit Pages permission for Group A
		 *Step Description: 
			- Check the Group A permission
			- In the permission table, untick the Edit Pages checkbox of the Group A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			- Edit Pages checkbox is deselected*/
		goToWikiPage("Wiki Home/" + title, ManageAccount.userType.ADMIN);
		editPagePermission(path, true, false);
		magAc.signOut();

		/*Step number: 3
		 *Step Name: Step 3: Check if the Group A has Edit Pages permission
		 *Step Description: 
			- Login as user member of Group A
			- Go to space 
			-
			-> Wiki
			- Select the wiki page
		 *Input Data: 

		 *Expected Outcome: 
			- The user can view PageA but cannot see Edit Page, Add Page; Move Page and Delete Page from More menu*/
		magAc.signIn(user, DATA_PASS);
		goToWiki();
		click(By.linkText(title));
		waitForElementNotPresent(ELEMENT_EDIT_PAGE_LINK);
		waitForElementNotPresent(ELEMENT_ADD_PAGE_LINK);
		click(ELEMENT_MORE_LINK);
		waitForElementNotPresent(ELEMENT_DELETE_LINK);
		waitForElementNotPresent(ELEMENT_MOVE_PAGE_LINK);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);

	}

	/**
	 *Case ID:113647.
	 *Test Case Name: Delete permissions for a group.
	 *Pre-Condition: - wiki page PageA is already created
	- Group A has permissions on PageA: View Pages or Edit Pages or both in Page Permissions
	- Member of Group A does not belong to any groups who have permission: View Pages, Edit Pages, in Page Permissions
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test04_DeletePermissionsForAGroup() {
		info("Test 4: Delete permissions for a group");
		String title = "title113647";
		String content = "content113647";
		String new_content = "newcontent113647";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String path = "*:/organization/employees";
		String[] userGroup = {path};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(0, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		editPagePermission(path, true, true);

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);

		/*Step Number: 1
		 *Step Name: Step 1: Open Page Permissions form
		 *Step Description: 
			- Go to space 
			-
			-> Wiki
			- Open the wiki page PageA
			- Select More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			- Page Permissions form displays*/

		/*Step number: 2
		 *Step Name: Step 2: Delete permission for Group A
		 *Step Description: 
			- Check the Group A permissions
			- Click Delete icon corresponding to Group A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			Permission of Group A is deleted*/
		deletePermissionWithUserAdmin(path, element_page);

		/*Step number: 3
		 *Step Name: Step 3: Check if Group A have deleted permission
		 *Step Description: 
			- Login as user member of Group A
			- Go to the space 
			-
			-> Wiki
		 *Input Data: 

		 *Expected Outcome: 
			The user will not see PageA in the left panel anymore*/ 
		checkViewPage(ManageAccount.userType.AUTHOR, element_page);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);

	}

	/**
	 *Case ID:113649.
	 *Test Case Name: Delete View permission for a user.
	 *Pre-Condition: - wiki page PageA is already created
	- User A already has permissions: View Pages, Edit Pages in Page Permissions
	- User A does not belong to any groups who have permissions: View Pages, Edit Pages in Page Permissions
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test05_DeleteViewPermissionForAUser() {
		info("Test 5: Delete View permission for a user");
		String title = "title113649";
		String content = "content113649";
		String new_content = "newcontent113649";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String[] userGroup = {user};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(1, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		editPagePermission(user, true, true);
		goToPermalink();
		String permalink = getPermalink();
		dialog.closeMessageDialog();

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);

		/*Step Number: 1
		 *Step Name: Step 1: Open Page Permissions form
		 *Step Description: 
			- Open wiki page PageA
			- Select More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			Page Permissions form appears*/

		/*Step number: 2
		 *Step Name: Step 2: Delete View permission for User A
		 *Step Description: 
			- Check the User A permission
			- In the permission table, untick the View Pages checkbox of the User A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			- The permission View Pages is unselected
			- The Edit Pages is auto
			-deselected if it is selected before*/
		goToWikiPage("Wiki Home/" + title, ManageAccount.userType.ADMIN);
		editPagePermission(user, false, false);
		magAc.signOut();

		/*Step number: 3
		 *Step Name: Step 3: Check if UserA can view the page
		 *Step Description: 
			- Log in as User A
			- Go to space 
			-
			-> Wiki
		 *Input Data: 

		 *Expected Outcome: 
			User A will not see PageA in the left panel. If User A use the direct link of PageA, "Page Not Found" is shown*/ 
		magAc.signIn(user, DATA_PASS);
		goToWiki();
		waitForElementNotPresent(By.linkText(title));
		magAc.signOut();
		goToWikiByPermalink(user, permalink, false, content);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);
	}

	/**
	 *Case ID:113650.
	 *Test Case Name: Delete View permission for a group.
	 *Pre-Condition: - wiki page PageA is already created
	- Group A already has permissions: View Pages, Edit Pages in Page Permissions
	- Member of Group A does not belong to any groups who have permissions: View Pages, Edit Pages in Page Permissions
	- Member of Group A does not have permission: View Pages, Edit Pages in Page Permissions
	 *Post-Condition: 
	 *Done with OSs and browsers : 
	 *Generated by phuongdt at 2014/09/18 14:17:25
	 */
	@Test
	public  void test06_DeleteViewPermissionForAGroup() {
		info("Test 6: Delete View permission for a group");
		String title = "title113650";
		String content = "content113650";
		String new_content = "newcontent113650";
		By element_page = By.linkText(title);
		String user = DATA_USER3;
		String path = "*:/organization/employees";
		String[] userGroup = {path};

		info("Add a wiki page");
		goToWiki();
		addBlankWikiPage(title, content, 0);

		info("Add user has permission default");
		deletePagePermission("any");
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);
		addPagePermission(0, userGroup);
		waitForElementNotPresent(ELEMENT_PAGE_PERMISSION_POPUP);

		info("Add edit page permission for " + user);
		editPagePermission(path, true, true);
		goToPermalink();
		String permalink = getPermalink();
		dialog.closeMessageDialog();

		info("Check user can view/edit wiki page");
		magAc.signOut();
		magAc.signIn(user, DATA_PASS);
		checkViewEditPage(element_page, content, new_content);

		magAc.signOut();
		magAc.signIn(DATA_USER1, DATA_PASS);

		/*Step Number: 1
		 *Step Name: Step 1: Open Page Permissions form
		 *Step Description: 
			- Open the wiki page PageA
			- Select More 
			-
			-> Page Permissions
		 *Input Data: 

		 *Expected Outcome: 
			Page Permissions form appears*/

		/*Step number: 2
		 *Step Name: Step 2: Delete View permission for Group A
		 *Step Description: 
			- Check the Group A permission
			- In the permission table, untick the View Pages checkbox of the Group A
			- Click Save
		 *Input Data: 

		 *Expected Outcome: 
			- The permission View Pages is unselected
			- The Edit Pages is auto
			-deselected if it is selected before*/
		goToWikiPage("Wiki Home/" + title, ManageAccount.userType.ADMIN);
		editPagePermission(path, false, false);
		magAc.signOut();

		/*Step number: 3
		 *Step Name: Step 3: Check if Group A can view the page
		 *Step Description: 
			- Log in as user member of Group A
			- Go to Wiki of the space.
		 *Input Data: 

		 *Expected Outcome: 
			The user will not see PageA in the left panel. If the user uses the direct link of PageA, "Page Not Found" is shown*/
		magAc.signIn(user, DATA_PASS);
		goToWiki();
		waitForElementNotPresent(By.linkText(title));
		magAc.signOut();
		goToWikiByPermalink(user, permalink, false, content);

		//Clear data
		info("Clear data");
		String[] wikiPath = {"Wiki Home/" + title};
		resetDataByDeleteWikiPage(ManageAccount.userType.ADMIN, wikiPath);

	}
}